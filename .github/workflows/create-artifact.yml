# Source artifact creation workflow
#
# This workflow creates a unified source artifact by combining:
# 1. gudzpoz/luajava - Java/JNI bindings for Lua
# 2. redis/redis deps/lua - Lua 5.1 native implementation
# 3. ispn-luajava - Infinispan customizations and build configuration
#
# The resulting artifact contains all source code needed for the multi-platform
# native library build workflow.
#
# Triggered by:
# - Manual dispatch with customizable inputs

name: Create Source Artifact

on:
  workflow_dispatch:
    inputs:
      luajava-branch:
        description: 'Checkout branch for gudzpoz/luajava (empty=default)'
        required: false
        default: ''
        type: string
      redis-branch:
        description: 'Checkout branch for redis/redis (empty=default)'
        required: false
        default: ''
        type: string
      version:
        description: 'Version number (e.g., 1.0.0 or 1.0.0-SNAPSHOT)'
        required: true
        type: string
      maven-group-id:
        description: 'Maven group ID (e.g., org.infinispan or com.example)'
        required: false
        default: 'org.infinispan'
        type: string

jobs:
  # Creates the source artifact by cloning and merging upstream repositories
  clone-and-verify:
    runs-on: ubuntu-latest

    steps:
      # Checkout this repository to access ispn-luajava customizations
      - name: Checkout main repository
        uses: actions/checkout@v4

      # Clone the upstream luajava repository with all submodules
      - name: Clone luajava repository
        uses: actions/checkout@v4
        with:
          repository: 'gudzpoz/luajava'
          path: 'luajava'
          ref: ${{ inputs.luajava-branch }}
          fetch-depth: 1
          submodules: true

      # Clone only the Lua 5.1 implementation from redis/redis (sparse checkout)
      # This is used to replace the default Lua implementation with Redis's fork
      - name: Clone redis/redis deps/lua folder
        uses: actions/checkout@v4
        with:
          repository: 'redis/redis'
          path: 'lua-native'
          ref: ${{ inputs.redis-branch }}
          sparse-checkout: |
            deps/lua
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      # Replace the default Lua 5.1 native code with Redis's implementation
      - name: Replace luajava/lua51/jni/lua51 with lua-native content
        run: |
          rm -rf luajava/lua51/jni/lua51
          cp -r lua-native/deps/lua luajava/lua51/jni/lua51

      # Apply Infinispan-specific customizations (build scripts, publishing config, etc.)
      - name: Replace luajava with ispn-luajava content
        run: |
          cp -r ispn-luajava/* luajava/

      # Write version and Maven metadata to files for use in downstream workflows
      - name: Write version to file
        run: |
          echo "${{ inputs.version }}" > luajava/version.txt
          echo "${{ inputs.maven-group-id }}" > luajava/maven-group-id.txt

      # Create a properties file with all build inputs and metadata for traceability
      - name: Write all input values to infinispan-build-info.properties
        run: |
          cat > luajava/infinispan-build-info.properties <<EOF
          # Build information from workflow inputs
          luajava.branch=${{ inputs.luajava-branch }}
          redis.branch=${{ inputs.redis-branch }}
          version=${{ inputs.version }}
          maven.group.id=${{ inputs.maven-group-id }}

          # Build metadata
          github.workflow=${{ github.workflow }}
          github.run.id=${{ github.run_id }}
          github.run.number=${{ github.run_number }}
          github.actor=${{ github.actor }}
          github.ref=${{ github.ref }}
          github.sha=${{ github.sha }}
          build.timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      # Upload the complete source tree as a GitHub Actions artifact
      # This artifact is consumed by the "Docker Build and Publish" workflow
      - name: Archive luajava folder
        uses: actions/upload-artifact@v4
        with:
          name: luajava-folder
          path: luajava
